# Bundix Workflow Guide

This flake uses **bundix** to support git sources (including SSH private gems) in your Gemfile.

## Why bundix?

Without bundix:
- ❌ bundlerEnv struggles with git sources
- ❌ SSH gems don't work reliably

With bundix:
- ✅ Git sources work (via `gemset.nix`)
- ✅ SSH authentication works during fetch phase
- ✅ Gems stay in Gemfile (compatible with non-Nix developers)

## Quick Start

```bash
# 1. Edit your Gemfile (include git sources as needed)
vim Gemfile

# 2. Update lock file
bundle lock

# 3. Generate gemset.nix with bundix
bundix -l

# 4. Build with Nix (needs SSH for private gems)
eval $(ssh-agent)
ssh-add ~/.ssh/id_ed25519
nix build --impure
```

## Required Files

```
your-project/
├── flake.nix          ✅ This template
├── .ruby-version      ✅ Ruby version (e.g., "3.3.0")
├── Gemfile            ✅ Your gems (public + private)
├── Gemfile.lock       ✅ Generated by: bundle lock
└── gemset.nix         ✅ Generated by: bundix -l
```

**IMPORTANT**: Commit all of these files to git!

## Gemfile with Git Sources

Your Gemfile can include both public and private gems:

```ruby
# Gemfile
source 'https://rubygems.org'

# Public gems from RubyGems.org
gem 'thor', '~> 1.3'
gem 'httparty', '~> 0.21'
gem 'aws-sdk-ec2', '~> 1.400'

# Private gems via SSH git sources
gem 'yourorg-utils',
    git: 'git@github.com:yourorg/yourorg-utils.git',
    tag: 'v1.2.3'

gem 'yourorg-aws',
    git: 'git@github.com:yourorg/yourorg-aws.git',
    branch: 'main'

# Can also use specific commits
gem 'yourorg-internal',
    git: 'git@github.com:yourorg/yourorg-internal.git',
    ref: 'abc123def456'
```

## Workflow

### Initial Setup

```bash
# 1. Ensure SSH agent is running
eval $(ssh-agent)
ssh-add ~/.ssh/id_ed25519

# 2. Test SSH access to GitHub
ssh -T git@github.com

# 3. Create/update Gemfile.lock
bundle lock

# 4. Generate gemset.nix
bundix -l

# 5. Build
nix build --impure
```

### Daily Development

```bash
# Enter development shell (bundix is available)
nix develop

# Work on your code, run tests, etc.
ruby main.rb
rspec spec/
```

### Adding a New Gem

```bash
# 1. Edit Gemfile
echo 'gem "newgem"' >> Gemfile

# 2. Update lock
bundle lock

# 3. Regenerate gemset.nix
bundix -l

# 4. Check the diff
git diff gemset.nix

# 5. Rebuild
nix build --impure

# 6. Commit
git add Gemfile Gemfile.lock gemset.nix
git commit -m "Add newgem"
```

### Updating an Existing Gem

```bash
# 1. Update specific gem
bundle update yourorg-utils

# 2. Regenerate gemset.nix
bundix -l

# 3. Check what changed
git diff Gemfile.lock gemset.nix

# 4. Rebuild
nix build --impure

# 5. Commit
git add Gemfile.lock gemset.nix
git commit -m "Update yourorg-utils"
```

### Updating All Gems

```bash
# 1. Update all gems
bundle update

# 2. Regenerate gemset.nix
bundix -l

# 3. Review changes
git diff Gemfile.lock gemset.nix

# 4. Rebuild
nix build --impure

# 5. Commit
git add Gemfile.lock gemset.nix
git commit -m "Update all gems"
```

## What bundix Does

```
Gemfile.lock                    gemset.nix (generated)
─────────────────               ──────────────────────

GEM                             {
  remote: https://rubygems.org    thor = {
  specs:                            version = "1.3.0";
    thor (1.3.0)                    source = {
                                      remotes = ["https://rubygems.org"];
GIT                                   sha256 = "...";
  remote: git@github.com:...          type = "gem";
  revision: abc123                  };
  tag: v1.2.3                     };
  specs:
    yourorg-utils (1.2.3)         yourorg-utils = {
                                    source = {
                                      type = "git";
                                      url = "git@github.com:...";
                                      rev = "abc123";
                                      sha256 = "...";
                                    };
                                  };
                                }
```

**Key insight**: bundix converts the lock file into Nix expressions that tell Nix exactly how to fetch each gem.

## SSH Requirements

### For Development

```bash
# Start SSH agent
eval $(ssh-agent)

# Add your key
ssh-add ~/.ssh/id_ed25519

# Verify
ssh-add -l

# Now enter dev shell
nix develop
```

### For Building

```bash
# SSH agent must be running
eval $(ssh-agent)
ssh-add ~/.ssh/id_ed25519

# Build with --impure (allows SSH access)
nix build --impure
```

**Why --impure?**
- Nix needs access to `$SSH_AUTH_SOCK` environment variable
- This allows fetchgit to use your SSH agent during the fetch phase
- The build itself is still reproducible (hashes are verified)

### For CI/CD

```yaml
# GitHub Actions example
name: Build

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install Nix
        uses: cachix/install-nix-action@v22

      - name: Setup SSH for private gems
        env:
          SSH_PRIVATE_KEY: ${{ secrets.PRIVATE_GEM_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts

          # Start SSH agent
          eval $(ssh-agent -s)
          ssh-add ~/.ssh/id_ed25519

          # Export SSH_AUTH_SOCK for Nix
          echo "SSH_AUTH_SOCK=$SSH_AUTH_SOCK" >> $GITHUB_ENV

      - name: Build
        run: nix build --impure
```

## When bundix Needs Help

Sometimes bundix can't calculate the sha256 for a git source. You'll see:

```bash
$ bundix -l
Error: Cannot determine sha256 for yourorg-utils
```

**Solution**: Manually calculate and add the hash:

```bash
# 1. Use nix-prefetch-git to get the hash
nix-prefetch-git --url git@github.com:yourorg/yourorg-utils.git --rev v1.2.3

# Output includes sha256: "sha256-abc123..."

# 2. Edit gemset.nix and update the sha256:
vim gemset.nix

# Find the yourorg-utils entry and update:
yourorg-utils = {
  source = {
    type = "git";
    url = "git@github.com:yourorg/yourorg-utils.git";
    rev = "abc123def";
    sha256 = "sha256-abc123...";  # ← Update this
  };
};
```

## Helper Script

Create `update-gems.sh` for convenience:

```bash
#!/usr/bin/env bash
# update-gems.sh - Helper script for gem updates

set -e

# Check SSH agent
if [ -z "$SSH_AUTH_SOCK" ]; then
  echo "Error: No SSH agent detected"
  echo "Run: eval \$(ssh-agent) && ssh-add"
  exit 1
fi

echo "Updating gems..."

# Update lock file
bundle lock

echo "Generating gemset.nix..."

# Generate gemset.nix
bundix -l

echo "Done!"
echo ""
echo "Review changes:"
echo "  git diff Gemfile.lock gemset.nix"
echo ""
echo "Then build:"
echo "  nix build --impure"
```

Make it executable:
```bash
chmod +x update-gems.sh
```

Usage:
```bash
# Start SSH agent
eval $(ssh-agent) && ssh-add

# Update gems
./update-gems.sh

# Review and commit
git diff
git add Gemfile.lock gemset.nix
git commit -m "Update gems"
```

## Troubleshooting

### Error: "No SSH agent detected"

**Problem**: SSH agent not running

**Solution**:
```bash
eval $(ssh-agent)
ssh-add ~/.ssh/id_ed25519
```

### Error: "Permission denied (publickey)"

**Problem**: SSH key not on GitHub or wrong key

**Solution**:
```bash
# Check which keys are loaded
ssh-add -l

# Test GitHub access
ssh -T git@github.com

# If fails, check your GitHub SSH keys:
# https://github.com/settings/keys
```

### Error: "Cannot determine sha256"

**Problem**: bundix can't fetch the git source to calculate hash

**Solution**: Manually calculate with `nix-prefetch-git` (see above)

### Error: "error: hash mismatch"

**Problem**: The git source changed but gemset.nix has old hash

**Solution**:
```bash
# Regenerate gemset.nix
bundix -l

# This recalculates all hashes
```

### Build works but gems not available at runtime

**Problem**: Probably didn't rebuild after updating gemset.nix

**Solution**:
```bash
# Force rebuild
nix build --impure --rebuild

# Or clear build cache
rm -rf result
nix build --impure
```

## Comparison with Pure bundlerEnv

| Aspect | Pure bundlerEnv | bundlerEnv + bundix |
|--------|----------------|---------------------|
| **Public gems** | ✅ Works | ✅ Works |
| **Git sources** | ❌ Unreliable | ✅ Works |
| **SSH private gems** | ❌ Doesn't work | ✅ Works with --impure |
| **Gemfile compatibility** | ✅ Direct | ✅ Via bundix conversion |
| **Extra files** | None | gemset.nix |
| **Extra steps** | None | Run `bundix -l` |
| **Build flag** | `nix build` | `nix build --impure` |

## Non-Nix Developers

Other developers on your team who don't use Nix can ignore all the Nix files:

```bash
# Non-Nix developer workflow (normal Ruby):
bundle install
ruby main.rb
rspec spec/

# They don't need to know about:
# - flake.nix
# - gemset.nix
# - bundix
# - Nix at all!
```

The Gemfile is the source of truth for everyone.

## Summary

**Key Points:**
1. ✅ Keep gems (including private ones) in Gemfile
2. ✅ Run `bundix -l` after any Gemfile changes
3. ✅ Commit gemset.nix along with Gemfile.lock
4. ✅ Use `nix build --impure` for SSH git sources
5. ✅ SSH agent must be running during builds

**The Workflow:**
```
Edit Gemfile → bundle lock → bundix -l → nix build --impure
```

**For CI/CD:**
- Set up SSH key as secret
- Start SSH agent before build
- Use `nix build --impure`

This gives you the best of both worlds:
- Regular bundler workflow for Ruby developers
- Reproducible Nix builds with SSH git support
