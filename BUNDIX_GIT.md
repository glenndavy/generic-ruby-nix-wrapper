# Using bundix with Git Sources (SSH)

Since your gems must stay in the Gemfile for other developers, let's explore using bundix with git sources.

## How It Should Work

```
Your Gemfile (has git sources)
    ↓
bundle install/lock (creates Gemfile.lock)
    ↓
bundix -l (generates gemset.nix)
    ↓
bundlerEnv reads gemset.nix
    ↓
Nix fetches gems (SSH access here!)
    ↓
Nix builds in sandbox
```

## Timeline of Fetching

**When you run `nix build`:**

```
Phase 1: Evaluation (reads gemset.nix)
  - No fetching yet
  - Just figures out what needs to be fetched

Phase 2: Realization (FETCHING HAPPENS HERE)
  - For each gem source in gemset.nix:
    * gem source (type="gem"): fetchurl from rubygems.org
    * git source (type="git"): fetchgit from git URL
  - SSH_AUTH_SOCK is available here
  - Your SSH keys are accessible
  - Network access is available
  - Sources downloaded to /nix/store

Phase 3: Build (sandbox, no network)
  - Uses pre-fetched sources from /nix/store
  - Compiles native extensions
  - Creates gem environment
```

**The key**: SSH fetching happens in Phase 2, where network IS available!

## Example Setup

### 1. Your Gemfile (must include git sources)

```ruby
# Gemfile
source 'https://rubygems.org'

# Public gems
gem 'thor', '~> 1.3'
gem 'aws-sdk-ec2', '~> 1.400'

# Private gems via SSH (required for other developers)
gem 'yourorg-utils',
    git: 'git@github.com:yourorg/yourorg-utils.git',
    tag: 'v1.2.3'

gem 'yourorg-aws',
    git: 'git@github.com:yourorg/yourorg-aws.git',
    branch: 'main'
```

### 2. Generate Gemfile.lock

```bash
# With SSH access for bundle to fetch git gems
eval $(ssh-agent)
ssh-add ~/.ssh/id_ed25519

bundle install  # or bundle lock
```

This creates `Gemfile.lock` with git source info.

### 3. Generate gemset.nix with bundix

```bash
# Install bundix if you don't have it
nix-shell -p bundix

# Generate gemset.nix
bundix -l
```

This creates `gemset.nix` that looks like:

```nix
{
  thor = {
    version = "1.3.0";
    source = {
      remotes = ["https://rubygems.org"];
      sha256 = "...";
      type = "gem";
    };
  };

  yourorg-utils = {
    source = {
      fetchSubmodules = false;
      rev = "abc123def...";
      sha256 = "sha256-XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX=";
      type = "git";
      url = "git@github.com:yourorg/yourorg-utils.git";
    };
  };

  yourorg-aws = {
    source = {
      fetchSubmodules = false;
      rev = "def456abc...";
      sha256 = "sha256-YYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY=";
      type = "git";
      url = "git@github.com:yourorg/yourorg-aws.git";
    };
  };
}
```

### 4. Update flake.nix to use gemset.nix

```nix
# Build the gem environment using bundlerEnv with gemset.nix
gemEnv = if hasGemfile then pkgs.bundlerEnv {
  name = "ruby-app-gems";
  inherit ruby;
  gemdir = ./.;

  # Use gemset.nix (generated by bundix)
  gemset = ./gemset.nix;

  # Add system dependencies if needed
  # buildInputs = with pkgs; [ postgresql ];
} else null;
```

### 5. Build with SSH access

```bash
# Start SSH agent
eval $(ssh-agent)
ssh-add ~/.ssh/id_ed25519

# Build (fetchgit happens here with SSH access)
nix build --impure
```

## The --impure Problem

You need `--impure` because:
- fetchgit needs `$SSH_AUTH_SOCK` from your environment
- Pure builds don't have access to environment variables
- This is a Nix security feature

**However**, there's a workaround for CI/CD...

## Making It Work in CI/CD

### Option 1: SSH Key in Nix Store (Less Secure)

```nix
gemEnv = pkgs.bundlerEnv {
  name = "ruby-app-gems";
  inherit ruby;
  gemdir = ./.;
  gemset = ./gemset.nix;

  # Pass SSH key explicitly
  NIX_SSL_CERT_FILE = "${pkgs.cacert}/etc/ssl/certs/ca-bundle.crt";
};
```

Then in CI:
```yaml
- name: Setup SSH
  run: |
    mkdir -p ~/.ssh
    echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_ed25519
    chmod 600 ~/.ssh/id_ed25519
    ssh-keyscan github.com >> ~/.ssh/known_hosts

- name: Build
  run: |
    eval $(ssh-agent)
    ssh-add ~/.ssh/id_ed25519
    nix build --impure
```

### Option 2: Nix Daemon SSH Config

Configure the nix-daemon to have SSH access:

```bash
# As root or in NixOS configuration
mkdir -p /root/.ssh
cp your-deploy-key /root/.ssh/id_ed25519
chmod 600 /root/.ssh/id_ed25519
ssh-keyscan github.com > /root/.ssh/known_hosts
```

Then builds can work without `--impure` (daemon has SSH).

## Workflow Summary

### Development Workflow

```bash
# 1. Developers use normal bundle workflow
bundle install  # Works with Gemfile git sources

# 2. For Nix builds, generate gemset.nix
bundix -l

# 3. Commit gemset.nix
git add gemset.nix
git commit -m "Update gemset.nix"

# 4. Build with Nix
eval $(ssh-agent) && ssh-add
nix build --impure
```

### When Updating Gems

```bash
# 1. Update Gemfile or Gemfile.lock
bundle update yourorg-utils

# 2. Regenerate gemset.nix
bundix -l

# 3. The new sha256 is automatically calculated by bundix
# Check the diff:
git diff gemset.nix

# 4. Commit
git add Gemfile.lock gemset.nix
git commit -m "Update yourorg-utils"

# 5. Rebuild
nix build --impure
```

## Does bundix Handle Git Sources Well?

**Mostly yes, with caveats:**

✅ **Pros:**
- bundix CAN parse git sources from Gemfile.lock
- It generates gemset.nix with fetchgit instructions
- bundlerEnv CAN use git sources from gemset.nix
- Fetching happens with SSH access available

⚠️ **Caveats:**
- Requires `--impure` to access SSH agent
- bundix must be able to fetch the git source to calculate sha256
- If bundix can't access private repos, you need to manually provide sha256

## If bundix Can't Access Private Repos

Sometimes bundix itself needs to fetch to calculate hashes. If it fails:

```bash
bundix -l
# Error: Can't fetch git@github.com:yourorg/private-gem.git
```

**Workaround**: Manually add sha256 to gemset.nix

```bash
# 1. Get the sha256 manually
nix-prefetch-git git@github.com:yourorg/yourorg-utils.git v1.2.3

# 2. Edit gemset.nix and add/update the sha256
vim gemset.nix
```

Or use a helper script:

```bash
#!/usr/bin/env bash
# update-git-gem-hash.sh

GEM_NAME=$1
GIT_URL=$2
REV=$3

eval $(ssh-agent)
ssh-add

SHA256=$(nix-prefetch-git --url "$GIT_URL" --rev "$REV" --quiet | jq -r .sha256)

echo "Update gemset.nix for $GEM_NAME:"
echo "  rev = \"$REV\";"
echo "  sha256 = \"$SHA256\";"
```

## Required Files

```
your-project/
├── flake.nix           # Uses gemset = ./gemset.nix
├── Gemfile             # Has git sources (for other devs)
├── Gemfile.lock        # Generated by bundle
├── gemset.nix          # Generated by bundix -l
└── .ruby-version
```

## Summary: bundix + Git Sources

**YES, bundix can work with SSH git sources:**

1. ✅ Git sources stay in Gemfile (other devs use `bundle install`)
2. ✅ bundix converts Gemfile.lock → gemset.nix (including git sources)
3. ✅ Fetching happens during Nix realization (SSH available)
4. ✅ Build phase uses pre-fetched sources

**BUT you need:**
- `--impure` flag for builds (SSH agent access)
- SSH agent running when building
- bundix able to calculate sha256 (or manual hash updates)

**This is likely your best option** given that gems must stay in Gemfile!

## Next Steps

1. Try `bundix -l` with your current Gemfile
2. Check if gemset.nix is generated correctly
3. Test `nix build --impure` with SSH agent
4. If it works, this is your solution!

Let me know if you want me to update the main flake.nix to use bundix + gemset.nix by default.
